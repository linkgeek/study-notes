## 路由器

### 一、定义

​		路由器，英文名位router，也叫网关设备，路由、路由，即为选择路径的设备，路由器主要是用来连接两个或多个网络的硬件设备，在网络间起网关的作用，是读取每一个数据包中的地址然后决定如何传送的专用智能性的网络设备。它能够理解不同的协议，例如某个局域网使用的以太网协议，因特网使用的TCP/IP协议。这样，路由器可以分析各种不同类型网络传来的数据包的目的地址，把非TCP/IP网络的地址转换成TCP/IP地址，或者反之；再根据选定的路由算法把各数据包按最佳路线传送到指定位置。所以路由器可以把非TCP/ IP网络连接到因特网上。

### 二、种类

对于路由器的认知，想必各位也都非常了解了，但是，你们可知路由器种类有哪些？

##### （1）按功能划分

可分为骨干级、企业级和接入级路由器。骨干级路由器数据吐量较大且重要，是企业级网络实现互连的关键。骨干级路由器要求性能的高速度及高可靠性。 网络通常采用热备份、双电源和双数据通路等技术来确保其可靠性。企业级路由器连接对象为许多终端系统，简单且数据流量较小。 

1. 接入路由器

   接入路由器连接家庭或ISP内的小型企业客户。接入路由器已经开始不只是提供SLIP或PPP连接，还支持诸如PPTP和IPSec等虚拟私有网络协议。这些协议要能在每个端口上运行。诸如ADSL等技术将很快提高各家庭的可用带宽，这将进一步增加接入路由器的负担。由于这些趋势，接入路由器将来会支持许多异构和高速端口，并在各个端口能够运行多种协议，同时还要避开电话交换网。

2. 企业级路由器

   企业或校园级路由器连接许多终端系统，其主要目标是以尽量便宜的方法实现尽可能多的端点互连，并且进一步要求支持不同的服务质量。许多现有的企业网络都是由Hub或网桥连接起来的以太网段。尽管这些设备价格便宜、易于安装、无需配置，但是它们不支持服务等级。相反，有路由器参与的网络能够将机器分成多个碰撞域，并因此能够控制一个网络的大小。此外，路由器还支持一定的服务等级，至少允许分成多个优先级别。但是路由器的每端口造价要贵些，并且在能够使用之前要进行大量的配置工作。因此，企业路由器的成败就在于是否提供大量端口且每端口的造价很低，是否容易配置，是否支持QoS。另外还要求企业级路由器有效地支持广播和组播。企业网络还要处理历史遗留的各种LAN技术，支持多种协议，包括IP、IPX和Vine。它们还要支持防火墙、包过滤以及大量的管理和安全策略以及VLAN。

3. 骨干级路由器 

   骨干级路由器实现企业级网络的互联。对它的要求是速度和可靠性，而代价则处于次要地位。硬件可靠性可以采用电话交换网中使用的技术，如热备份、双电源、双数据通路等来获得。这些技术对所有骨干路由器而言差不多是标准的。骨干IP路由器的主要性能瓶颈是在转发表中查找某个路由所耗的时间。当收到一个包时，输入端口在转发表中查找该包的目的地址以确定其目的端口，当包越短或者当包要发往许多目的端口时，势必增加路由查找的代价。因此，将一些常访问的目的端口放到缓存中能够提高路由查找的效率。不管是输入缓冲还是输出缓冲路由器，都存在路由查找的瓶颈问题。除了性能瓶颈问题，路由器的稳定性也是一个常被忽视的问题。

**（2）按结构划分**

可以划分为模块化和非模块化路由器。 模块化路由器可以实现路由器的灵活配置，适应企业的业务需求；非模块化路由器只能提供固定单一的端口。通常情况下，高端路由器是模块化结构，低端路由器是非模块化结构的。

**（3）按所处网络位置划分**

可分为“边界路由器”和“中间节点路由器”。在广域网范围内的路由器按其转发报文的性能可以分为两种类型，即边界路由器和中间节点路由器。

1. 边界类

   尽管在不断改进的各种路由协议中，对这两类路由器所使用的名称可能有很大的差别，但所发挥的作用却是一样的。 很明显"边界路由器"是处于网络边缘，用于不同网络路由器的连接；而"中间节点路由器"则处于网络的中间，通常用于连接不同网络，起到一个数据转发的桥梁作用。

2. 中间节点类

   中间节点路由器在网络中传输时，提供报文的存储和转发。同时根据当前的路由表所保持的路由信息情况，选择最好的路径传送报文。由多个互连的LAN组成的公司或企业网络一侧和外界广域网相连接的路由器，就是这个企业网络的连界路由器。它从外部广域网收集向企业网络寻址的信息，转发到企业网络中有关的网络段；另一方面集中企业网络中各个LAN段向外部广域网发送的报文，对相关的报文确定最好的传输路径。

### 三、路由器的构成

 　路由器具有四个要素：输入端口、输出端口、交换开关和路由处理器。

![](https://img-blog.csdnimg.cn/20190205135058114.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NhbnR0ZGU=,size_16,color_FFFFFF,t_70)

路由器内部整体分为两部分：路由选择部分、分组转发部分
路由选择部分：软件、控制层面、核心是路由选择处理机
分组转发部分：硬件、数据层面、核心是处理芯片和交换结构

### 四、基本工作过程

路由器在转发包时，首先会通过端口将发过来的包接收进来，这一步的工作过程取决于端口对应的通信技术。对于以太网端口来说，就是按照以太网规范进行工作，而无线局域网端口则按照无线局域网的规范工作，总之就是委托端口的硬件将包接收进来。接下来，转发模块会根据接收到的包的 IP头部中记录的接收方 IP地址，在路由表中进行查询，以此判断转发目标。然后，转发模块将包转移到转发目标对应的端口，端口再按照硬件的规则将包发送出去，也就是转发模块委托端口模块将包发送出去的意思。

![](https://img-blog.csdnimg.cn/20190205135041292.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NhbnR0ZGU=,size_16,color_FFFFFF,t_70)

#### 4.1 路由器根据路由表对包进行转发

交换机是通过 MAC头部中的接收方 MAC地址来判断转发目标的，而路由器则是根据 IP头部中的 IP地址来判断的。

![](https://upload-images.jianshu.io/upload_images/1859399-0cf385e2551e8df9.png?imageMogr2/auto-orient/strip|imageView2/2/w/613/format/webp)

> 交换机在地址表中只匹配完全一致的记录，而***路由器则会忽略主机号部分，只匹配网络号部分***。打个比方，路由器在转发包的时候只看接收方地址属于哪个区， × ×区发往这一边， × ×区发往那一边。

#### 4.2 路由器的包接收操作

路由器的整个工作过程。首先，路由器会接收网络包。路由器的端口有各种不同的类型，这里我们只介绍以太网端口是如何接收包的。以太网端口的结构和计算机的网卡基本相同，接收包并存放到缓冲区中的过程也和网卡几乎没有区别。首先，信号到达网线接口部分，其中的 PHY（ MAU）模块和 MAC模块将信号转换为数字信息，然后通过包末尾的 FCS进行错误校验，如果没问题则检查 MAC头部中的接收方 MAC地址，看看是不是发给自己的包，如果是就放到接收缓冲区中，否则就丢弃这个包。如果包的接收方 MAC地址不是自己，说明这个包是发给其他设备的，如果接收这个包就违反了以太网的规则。

> ***路由器的端口都具有 MAC地址，只接收与自身地址匹配的包，遇到不匹配的包则直接丢弃。***

#### 4.3 查询路由表确定输出端口

##### **MAC头部作用**

完成包接收操作之后，路由器就会丢弃包开头的 MAC头部。 MAC头部的作用就是将包送达路由器，其中的接收方 MAC地址就是路由器端口的 MAC地址。因此，当包到达路由器之后， MAC头部的任务就完成了，于是 MAC头部就会被丢弃。

> **通过路由器转发的网络包，其接收方 MAC地址为路由器端口的 MAC地址。**

##### 路由器会根据 IP头部中的内容进行包的转发操作

- a）查询路由表判断转发目标

  关于具体的工作过程，我们还是来看一个实际的例子，如上图的情况，假设地址为 10. 10. 1. 101的计算机要向地址为 192. 168. 1. 10的服务器发送一个包，这个包先到达图中的路由器。判断转发目标的第一步，就是根据包的接收方 IP地址查询路由表中的目标地址栏，以找到相匹配的记录。就像前面讲过的一样，这个匹配并不是匹配全部 32个比特，而是根据子网掩码列中的值判断网络号的比特数，并匹配相应数量的比特 33。例如，上图的第 3行，子网掩码列为 255. 255. 255. 0，就表示需要匹配从左起 24个比特。网络包的接收方 IP地址和路由表中的目标地址左起 24个比特的内容都是 192. 168. 1，因此两者是匹配的，该行记录就是候选转发目标之一。

- b）路由器修改包的有效期

- c）路由器通过分片功能拆分大网络包

- d）路由器的发送操作

  这一步操作取决于输出端口的类型。如果是以太网端口，则按照以太网的规则将包转换为电信号发送出去；如果是 ADSL则按照 ADSL的规则来转换，以此类推。在家庭网络中，路由器后面一般连接 ADSL等线路接入互联网，因此路由器会根据接入网的规则来发送包。不过，要理解具体的操作过程，需要先理解相应的通信线路 ，比较复杂，因此我们留到下一章探索互联网内部时再讲解。这里，我们假设路由器位于公司等局域网的内部，即输出端口也是以太网，看看这种情况是如何操作的。

  以太网的包发送操作是根据以太网规则来进行的，即便设备种类不同，规则也是相同的。也就是说，其基本过程和协议栈中的 IP模块发送包的过程是相同的，即在包前面加上 MAC头部，

  设置其中的一些字段，然后将完成的包转换成电信号并发送出去。下面来简单复习一下这个过程。首先，为了判断 MAC头部中的 MAC地址应该填写什么值，我们需要根据路由表的网关列判断对方的地址。如果网关是一个 IP地址，则这个 IP地址就是我们要转发到的目标地址；如果网关为空，则 IP头部中的接收方 IP地址就是要转发到的目标地址。知道对方的 IP地址之后，接下来需要通过 ARP根据 IP地址查询 MAC地址，并将查询的结果作为接收方 MAC地址。路由器也有 ARP缓存，因此首先会在 ARP缓存中查询，如果找不到则发送 ARP查询请求。

  路由器判断下一个转发目标的方法如下。

  - 如果路由表的网关列内容为 IP地址，则该地址就是下一个转发目标。
  - 如果路由表的网关列内容为空，则 IP头部中的接收方 IP地址就是下一个转发目标。

  路由器也会使用 ARP来查询下一个转发目标的 MAC地址。

  网络包完成后，接下来会将其转换成电信号并通过端口发送出去。这一步的工作过程和计算机也是相同的。例如，当以太网工作在半双工模式时，需要先确认线路中没有其他信号后才能发送，如果检测到碰撞，则需要等待一段时间后重发。如果以太网工作在全双工模式，则不需要确认线路中的信号，可以直接发送。如果输出端口为以太网，则发送出去的网络包会通过交换机到达下一个路由器。由于接收方 MAC地址就是下一个路由器的地址，所以交换机会根据这一地址将包传输到下一个路由器。接下来，下一个路由器会将包转发给再下一个路由器，经过层层转发之后，网络包就到达了最终的目的地。

### 五、路由器与交换机的关系

路由器和交换机的区别在于它们分别工作在网络层和数据链路层，因此他们各自的功能有很大区别。处理数据的机制也不一样，交换机是根据Mac地址进行数据转发，而路由器则根据路由信息进行传递，路由信息里有到达目的网络的路径。 